# 产品指南

## 初始构想
创建一个根据微信公众号文章的网址可以把微信公众号的文章转换成 Markdown 格式，根据文章名字命名文件，保存到本地，还可以下载文章中的图片的工作流。

## 产品愿景
一款高效、可靠的生产力工具，旨在帮助用户建立私有的微信公众号文章知识库。它不仅能完美保留文章的排版结构和图片资源，还具备灵活的扩展性，能够打通本地文件系统与飞书云文档之间的壁垒。

## 路线图与阶段规划

### 第一阶段：本地归档 (V0.1)
重点在于稳健的抓取和高质量的本地转换。
- **核心功能：** 通过命令行接收微信文章 URL 并将其转换为 Markdown。
- **元数据提取：** 提取并保存文章元数据（标题、作者、日期、公众号名称）为 YAML Frontmatter。
- **资源管理：** 下载所有图片到本地，并重写 Markdown 链接指向本地路径。

### 第一阶段扩展：云端同步 (V0.2)
重点在于集成与生产力提升。
- **飞书集成：** 对接飞书开放平台 API。
- **同步工作流：** 解析归档内容，并将其一键导入为飞书云文档。
- **图床处理：** 解决防盗链，将图片转存至飞书云空间。

### 第二阶段：Web 界面化改造 (V0.3)
重点在于降低使用门槛，提供可视化的操作体验。
- **Web Dashboard：** 基于 Next.js 构建现代化管理后台。
- **个性化欢迎语：** 智能识别用户登录态，动态切换欢迎语（“欢迎回来...”）。
- **可视化任务管理：** 网页输入 URL，实时查看抓取与同步进度。
- **历史记录管理：** 提供可视化的历史转存列表。

### 第三阶段：SaaS 服务化 (V0.4)
- **状态**: ✅ 已完成

### 第四阶段：架构升级 (V0.5)
- **状态**: ✅ 已完成

### 第五阶段：SaaS 基础建设 (V0.6)
- **状态**: ✅ 已完成
- **核心目标**: 邮箱注册体系与本地化存储优化（适配 40G 轻量服务器）。
- **认证**: 支持邮箱/密码注册与登录。
- **文本存储**: Markdown 内容存入 MongoDB (Option A)。
- **图片存储**: 本地静态目录管理 + 图片压缩 + 用户隔离 + 智能缓存（物理单例，逻辑多占）。
- **媒体增强**: GIF 动画完美支持。
- **运维**: 每日自动化备份与轮替机制。

### 第六阶段：社区与多媒体增强 (V0.7)
- **状态**: 🚧 进行中
- **核心模块 1：多维目录管理 (Structure)**:
    *   **架构设计**: 双层文件夹结构（限制 2 层嵌套），解耦物理存储（删目录不删文章，文章自动退回 Inbox）。
    *   **Inbox 机制**: 新文章默认 `folderId` 为空，进入收件箱视图并显示未处理计数。
    *   **文件夹 CRUD**: 支持创建、重命名、拖拽排序及层级深度校验。
    *   **拖拽交互 (DND)**: 桌面端支持单篇/多选文章拖入目录，具备文件夹高亮反馈及折叠目录悬停展开功能。
    *   **移动端适配**: 支持左滑移动及批量管理模式（Bottom Sheet 交互）。
    *   **快速归档**: 阅读器顶部集成 Command Palette（命令面板），支持关键字搜索并快速跨目录移动。
- **核心模块 2：轻量化视频支持 (Video - Embed Only)**:
    *   **拒绝物理存储**: 坚决不下载视频文件，避免服务器爆盘。
    *   **Iframe 嵌入**: 针对腾讯视频插件，解析 `vid` 并内嵌官方播放器。
    *   **占位探测**: 针对原生 MP4，提取封面并显示“跳转原文播放”占位符。
- **社区与反馈**:
    *   **透明看板**: 首页公开数据（Stats Panel ✅ 已上线）。
    *   **价值微反馈**: 放弃复杂的足迹页面，改为 Dashboard 顶部的一句话成就统计（“已守护 XX 篇文章，沉淀 XX 万字”），强化数字资产累积感。
- **核心模块 3：极简匿名分享 (Share)**:
    *   **快照机制**: 详情页一键开启分享，生成唯一 Hash URL (w2d.chat/s/[hash])。
    *   **匿名访问**: 无需登录即可阅读，后端代理保障资源可见。
    *   **时效管理**: 默认 7 天有效期，自动过期保护资源。
    *   **品牌回流**: 页脚植入 "Powered by Wechat2doc" 标识，实现裂变增长。
- **核心模块 4：数据主权与导出 (Export)**:
    *   **定位**: 仅做归档源，不提供在线编辑。
    *   **Markdown 包**: 一键导出 Markdown 源码及本地图片资源（ZIP 格式）。
    *   **PDF**: 采用 Print CSS 优化，调用浏览器原生打印实现像素级导出，零服务端负载。
    *   **Docx**: 前端静态转换，满足文档编辑需求。

## 关键约束
- **Markdown 兼容性：** 生成的 Markdown 适配标准编辑器及飞书导入要求。
- **安全第一：** 用户凭证全链路加密，保护用户隐私。
- **高保真：** 像素级还原微信文章排版，智能去除干扰信息。
- **资源优化**: 针对小规格服务器（40G 磁盘）优化存储策略。

---

## 附录：V0.6 认证体系业务规则 (2026-01-22 更新)

### 1. 认证策略：邮箱注册 (MVP)
*   **原则**：遵循 MVP 原则，降低初期复杂度，快速上线验证。
*   **实现**：提供“邮箱+密码”注册和登录功能。
*   **强制验证**：注册流程必须包含邮箱验证步骤，防止垃圾账号。
*   **未来规划**：微信扫码登录、飞书登录及手机号验证登录作为后续迭代功能，视用户反馈决定上线时间。

### 2. 账号体系架构：以 User ID 为核心
*   **主键原则**：数据库物理层面的 Foreign Key 永远指向内部生成的唯一 `User ID`。
*   **多重标识**：`email`, `phoneNumber`, `wechatUnionId` 等仅作为 `User` 表上的 **Unique Index (唯一索引)**，不作为外键关联。
*   **业务稳定**：无论登录方式如何增加或变更，用户保存的文章、支付记录等始终关联 `User ID`，确保业务逻辑稳定性。
*   **账号合并**：架构上支持未来实现多账号合并逻辑。

### 3. 邮箱验证机制 (业务规则)
*   **方式**：**验证码** (6位数字)。
*   **有效性**：300秒 (5分钟) 内有效。
*   **失败限制**：验证失败 3 次后该验证码失效。
*   **防刷机制**：同一邮箱/IP 在 60 秒内只能请求一次，1 小时内限制发送次数 (如 5 次)。
*   **结果**：验证通过后，系统需记录验证状态。

### 4. 登录入口 UI
*   仅展示邮箱登录/注册表单。
*   不展示微信、飞书等第三方登录按钮（V0.6 阶段）。

### 5. 存储策略优化 (V0.6 - 物理单例，逻辑多占)
*   **核心矛盾**：为了节省服务器资源（图片/存储）与解决配额计算的冲突。
*   **解决方案**：
    *   **移除唯一约束**：`Article` 表移除 `originalUrl` 的唯一性约束，改为允许重复 URL 记录。
    *   **复合唯一索引**：新增 `userId` + `originalUrl` 的复合唯一索引，确保同一用户不重复存储同一篇文章。
    *   **智能缓存命中**：当用户 B 存储已存在的 URL 时，不再重新抓取和下载图片，而是直接复制已有记录（状态为 `stored`）的元数据和内容路径，创建属于 B 的新记录。
    *   **效果**：物理文件（图片）共享一份，数据库记录逻辑独立，配额计算准确，且大幅提升响应速度。
