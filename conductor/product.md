# 产品指南

## 初始构想
创建一个根据微信公众号文章的网址可以把微信公众号的文章转换成 Markdown 格式，根据文章名字命名文件，保存到本地，还可以下载文章中的图片的工作流。

## 产品愿景
一款高效、可靠的命令行工具 (CLI)，旨在帮助用户建立私有的微信公众号文章知识库。它不仅能完美保留文章的排版结构和图片资源，还具备灵活的扩展性，能够打通本地文件系统与飞书云文档之间的壁垒。

## 路线图与阶段规划

### 第一阶段：本地归档 (V1.0)
重点在于稳健的抓取和高质量的本地转换。
- **核心功能：** 通过 CLI 接收微信文章 URL 并将其转换为 Markdown。
- **元数据提取：** 提取并保存文章元数据（标题、作者、日期、公众号名称）为 YAML Frontmatter。
- **资源管理：** 下载所有图片到本地，并重写 Markdown 链接指向本地路径。
- **文件结构：** “独立文章包”模式。为每篇文章创建一个专用文件夹，包含 `.md` 文件和 `assets/` 子文件夹。
- **重名处理：** 对同名文章自动重命名（例如 `标题_1`），防止文件覆盖。

### 第一阶段扩展：云端同步 (V1.1)
重点在于集成与生产力提升。
- **飞书集成：** 对接飞书开放平台 API。
- **同步工作流：** 解析本地归档的 Markdown 文件，并将其上传为飞书云文档。
- **图床处理：** 将本地图片上传至飞书或处理符合飞书文档要求的图片托管。

### 第二阶段：图形化交互 (V1.2)
重点在于降低使用门槛，提供可视化的操作体验。
- **Web Dashboard：** 基于 Next.js 构建本地运行的 Web 管理后台。
- **可视化任务管理：** 通过网页输入 URL，实时查看抓取进度条和日志。
- **文章库预览：** 在网页上直接预览已归档的 Markdown 文章和图片。
- **一键同步：** 在文章详情页提供“同步至飞书”的按钮，替代命令行操作。

### 第三阶段：SaaS 服务化 (V0.4)
重点在于多用户支持与安全性保障。
- **飞书 OAuth 2.0 登录：** 支持用户通过飞书扫码登录，并在右上角显示用户头像与昵称，提供退出菜单。
- **个人空间所有权转换：** 切换 API 调用身份为“用户身份”，使转存文档的所有者直接为用户本人，拥有完整管理权限。
- **Token 安全管理：** 
  - 后端加密存储用户的 `user_access_token` 与 `refresh_token`（AES-256-GCM 加密）。
  - 实现 Token 自动刷新机制，确保离线状态下的任务执行。
  - 用户注销时物理删除 Token 记录。
- **多用户隔离：** 首页转存历史根据 `userId` 进行严格隔离，仅存储标题、URL、状态等基础元数据以缩减存储压力。
- **部署适配：** 准备 PM2 进程托管与 Nginx 反向代理配置，适配公网环境（初期维持本地 SQLite 存储，部署阶段再进行 MongoDB 迁移）。

### 第四阶段：社区与探索 (V0.5)
重点在于通过“双重面孔”系统建立内容的社会化连接。
- **透明数据看板 (Open Stats)：** 在首页 Hero 区域动态展示“累计转存篇数”、“今日新增”及“节省时间”等核心指标。既作为管理员的仪表盘，也作为用户的信任背书 (Social Proof)。
- **公共面孔 (未登录 - 热门榜单)：** 列表演变为“热门转存”排行榜，按转存次数从高到低排列，展示社区最受关注的内容，隐藏个人敏感信息。
- **私人面孔 (已登录 - 个人空间)：** 列表自动切换为“我的转存历史”，展示个人的操作记录、实时状态（成功/处理中/失败）以及精确的转存时间。
- **极简 Tab 切换：** 登录后支持在“我的转存”与“热门榜单”之间快速切换。

## 用户体验 (CLI)
- **输入：** 
  - 抓取：运行 `wgrab <url>` (或 `wechat-grab`)。
  - 同步：运行 `wsync <article_dir>` 将本地文章一键导入飞书云文档。
- **反馈：** 实时进度条显示文本和图片的下载状态。
- **输出：** 在当前目录（或用户指定的输出路径）创建整洁的文件夹结构。

## 关键约束
- **Markdown 兼容性：** 生成的 Markdown 必须在标准编辑器（如 VS Code, Obsidian）中正确渲染，并适配后续飞书导入的要求。
- **反爬虫应对：** 基础的请求头（User-Agent）处理，模拟浏览器行为访问微信文章。
